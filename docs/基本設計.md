# 顧客管理システム(CMS) 基本設計書

## 1. プロジェクト概要
- システム名：MyCMS
- システムの目的：営業部門向け顧客管理システム。営業担当者が顧客情報の検索、登録・更新・削除、帳票出力を効率化すること。
- 想定ユーザー：営業担当者および管理者。
- 使用技術スタック：
  - バックエンド：Laravel 9+
  - フロントエンド：React (Vite)
  - データベース：MySQL
  - コンテナ：Docker / Docker Compose
  - 認証：今回は省略
  - フロント状態管理：React Hooks（useState, useEffect）

## 2. 画面設計
### 2.1 画面一覧
| 画面名        | URL                 | 主な機能                  |
| ---------- | ------------------- | --------------------- |
| ホーム       | `/`            | ホーム画面            |
| 企業一覧   | `/clients`          | 検索、一覧表示、PDF取得、新規追加、編集、削除、詳細表示 |
| 企業カテゴリ管理      | `/categories`       | カテゴリ管理（CRUD）          |
| 担当者一覧  | `/persons`      | クライアント窓口情報の一覧表示、新規追加、編集、削除  |
| CSVから企業情報登録   | `/clients/import`   | CSVをインポートして情報を登録   |

### 画面遷移図
```css
[ホーム]　-> [クライアント一覧] -> (詳細/編集/新規追加)
          -> [企業カテゴリ一覧] -> (詳細/編集/新規追加)
          -> [担当者] -> (詳細/編集/新規追加)
          ->[CSVから企業登録]

```
## 3. 機能設計
### 3.1 クライアント管理
- **一覧表示**：ステータス、カテゴリ、企業名、担当者名で検索可能
- **CRUD**：
  - 新規登録フォーム
  - 編集フォーム
  - 削除確認ダイアログ
- **バリデーション**
  - 必須項目：会社名、ステータス
  - メール形式チェック
  - カテゴリ存在チェック（DBに登録済か）

以下、省略
### 3.2 企業カテゴリ管理
### 3.3 担当者管理
### 3.4 CSVインポート
- プレビュー表示、エラー行ハイライト、DB登録


## 4. API設計
### エンドポイント一覧
| エンドポイント                        | メソッド   | リクエスト                                            | レスポンス                           | 説明          |
| ------------------------------ | ------ | ------------------------------------------------ | ------------------------------- | ----------- |
| `/api/clients`                 | GET    | `status`, `company_name`, `company_category_ids` | JSON一覧                          | クライアント検索・取得 |
| `/api/clients`                 | POST   | クライアント情報                                         | 新規クライアント情報                      | 新規登録        |
| `/api/clients/:id`             | PUT    | クライアント情報                                         | 更新後の情報                          | 編集          |
| `/api/clients/:id`             | DELETE | -                                                | 成功メッセージ                         | 削除          |
| `/api/clients/import/preview`  | POST   | CSVファイル                                          | `records`, `errors`, `warnings` | CSVプレビュー    |
| `/api/clients/import/register` | POST   | プレビュー有効行                                         | 登録件数・スキップ行                      | CSV登録       |

## 5. DB設計
### 5.1 ER図（簡略版）
```scss
clients (1) ---- (*) client_category (*)
company_categories (1) ---- (*) client_category
persons (1) ---- (*) clients
```
### 5.2 テーブル定義
**clients**
| カラム名                | 型                                              | 制約                  |
| ------------------- | ---------------------------------------------- | ------------------- |
| id                  | int                                            | PK, auto\_increment |
| company\_name       | varchar(255)                                   | not null            |
| email               | varchar(255)                                   | null                |
| contact\_person\_id | int                                            | FK persons.id       |
| phone               | varchar(20)                                    | null                |
| address             | varchar(255)                                   | null                |
| status              | enum('prospect','active','suspended','closed') | not null            |
| created\_at         | timestamp                                      | not null            |
| updated\_at         | timestamp                                      | not null            |

**company_categories**
| カラム名 | 型            | 制約       |
| ---- | ------------ | -------- |
| id   | int          | PK       |
| name | varchar(255) | not null |

**client_company_category(中間テーブル)**
| カラム名 | 型            | 制約       |
| ---- | ------------ | -------- |
| id   | int          | PK       |
| name | varchar(255) | not null |

## 6. フロントエンド
### 6.1 コンポーネント構成
| コンポーネント名           | 役割                | props / State                                 | 備考                      |
| ------------------ | ----------------- | --------------------------------------------- | ----------------------- |
| `Client`           | クライアント管理ページ（親）    | - `clients`（一覧データ）<br>- `editingClient`（編集対象） | 子コンポーネントを統括し、API呼び出しを担当 |
| `ClientForm`       | クライアント新規登録・編集フォーム | - `editingClient`<br>- `onSubmit`             | 新規/編集のフォーム、郵便番号検索ボタンも含む |
| `ClientList`       | クライアント一覧表示        | - `clients`<br>- `onEdit`<br>- `onDelete`     | 編集・削除ボタンあり              |
| `ClientSearch`     | 検索フォーム            | - `onResults`                                 | ステータス・カテゴリ・会社名・担当者で検索可能 |
| `Button`           | 汎用ボタン             | - `variant`<br>- `onClick`                    | Tailwind スタイリング用        |
| `InputField`       | 汎用入力              | - `label`<br>- `value`<br>- `onChange`        | Tailwind フォーム入力用        |
| `SelectField`      | 単一選択ドロップダウン       | - `label`<br>- `value`<br>- `onChange`        | Tailwind スタイリング用        |
| `MultiSelectField` | 複数選択ドロップダウン       | - `label`<br>- `values`<br>- `onChange`       | Tailwind スタイリング用        |

### 6.2 状態管理
- 各画面で```useState```、API結果はPropsで親から子へ
- CSVプレビュー時は```previewData```と```validRecords```を管理
- React Routerで画面遷移

## 7. バックエンド
- **Controller**: 
  - ```ClientController```： CRUD、CSVインポート
  - ```CompanyCategoryController```: CRUD
  - ```ClientCompanyCategoryController```: CRUD
  - ```PersonController```: CRUD
  - ```Api/PdfController```: PDF生成

- **Service**
  - CSV解析やDB登録のビジネスロジック

- **Validation**
  - FormRequestクラスで入力チェック

## 8 テスト
- **Laravel**: PHP Unit
  - APIテスト（正常系・異常系）
  - CSV登録テスト
- **React**: ＜未実施＞ Testing Library + Jest
  - フォーム入力・バリデーション
  - コンポーネントレンダリング
  - ボタンクリックでのイベント発火

## 9. 環境構築
- DockerでWeb / DB / Nodeを起動
- ```.env``` 設定例
- Laravel: ```php artisan migrate```
- React: ```npm install``` → ```npm run dev```

## 10. 非機能要件
- パフォーマンス：一覧1000件程度でも高速に表示
- セキュリティ：
  - CSRF、XSS対策
- ロギング：Laravelログに記録
